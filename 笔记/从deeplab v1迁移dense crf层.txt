1.复制util下的densecrf_pairwise，densecrf_util和permutohedral.cpp/hpp

2.复制densecrf_layer.cpp，更改头文件引用
#include "caffe/vision_layers.hpp" --> #include "caffe/layers/densecrf_layer.hpp"
将最后注册部分改为
#ifdef CPU_ONLY
STUB_GPU(DenseCRFLayer);
#endif
INSTANTIATE_CLASS(DenseCRFLayer);
REGISTER_LAYER_CLASS(DenseCRF);

3.修改densecrf_layer.cpp，去掉bottom[1]关于对data_dim的输入
densecrf_layer.hpp中修改MinBottomBlobs()为ExactNumBottomBlobs()，返回2
删除Forward_cpu中关于data_dim_offset的代码，H_和W_直接使用pad_*变量赋值
删除Reshape中关于bottom[1]的代码
将所有的bottom[2]改为bottom[1]

3.从vision_layers.hpp取出densecrf_layer.hpp
注意要#include "caffe/util/densecrf_pairwise.hpp"
将：
  virtual inline LayerParameter_LayerType type() const {
    return LayerParameter_LayerType_DENSE_CRF;
  }
替换为
  virtual inline const char* type() const { return "DenseCRF"; }

4.将DenseCRFParameter的proto定义添加到LayerParameter中，需要在V1LayerParameter添加层定义的proto: DENSE_CRF = 40;

5.使用方法
voc最佳参数
layers {
  bottom: "fc8_interp"  # fc8 output before softmax
  bottom: "data"
  top: "crf_inf"
  name: "crf"
  type: "DenseCRF"
  dense_crf_param { 
    max_iter: 10
    pos_w: 3
    pos_xy_std: 3
    bi_w: 5
    bi_xy_std: 50
    bi_rgb_std: 10
  }
  include: { phase: TEST }
}

2017/01/22 16:52 魏震
